kind: pipeline
name: main

platform:
  os: linux
  arch: amd64

steps:

- name: build (staging)
  image: plugins/docker
  settings:
    username:
      from_secret: docker_username
    password:
      from_secret: docker_password
    repo: rangerdigital/tohru-parser
    tags: staging
  when:
    event:
      include:
        - push
      exclude:
        - promote

- name: update swarm (staging)
  image: alpine
  environment:
      WEBHOOK:
        from_secret: stag_webhook
  command:
    - apk add curl
    - curl -k --resolve portainer.sylvanas.dream:443:10.0.0.1 $${WEBHOOK}
  when:
    event:
      include:
        - push
      exclude:
        - promote

- name: build (production)
  image: plugins/docker
  settings:
    username:
      from_secret: docker_username
    password:
      from_secret: docker_password
    repo: rangerdigital/tohru-parser
    tags: latest
  when:
    event:
      - promote
